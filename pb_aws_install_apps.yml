---
  - hosts: jumpbox
    gather_facts: true
    become: no
    vars_files:
      - vars_infrastructure.yml
      - vars_aws.yml
    roles:
    - {role: app-basic-config, become: True}
    - {role: aws-facts, become: False}
    environment:
      AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
      AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"

   # Setup front-end load balancer tier

  - name: setup load-balancer tier
    hosts: frontends
    become: yes
    roles:
      - {name: app-basic-config, tags: app-basic-config}
      - {name: app-loadbalancer, tags: [lbs, haproxy]}
    environment:
      AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
      AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"

  # Setup application servers tier

  - name: setup app tier
    hosts: apps
    become: yes
    gather_facts: false
    roles:
      - {name: app-basic-config, tags: app-basic-config}
      - {name: app-apps, tags: [apps, tomcat]}
    environment:
      AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
      AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"

  # Setup database tier

  - name: setup database tier
    become: yes
    hosts: appdbs
    roles:
      - {name: app-basic-config, tags: app-basic-config}
      - {name: app-appdb, tags: [dbs, postgres]}
    environment:
      AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
      AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
